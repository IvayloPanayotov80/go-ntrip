<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Температура – 8 канала (24 часа)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #151925;
      --panel-2: #1b2030;
      --text: #e6e9ef;
      --muted: #9aa3b2;
      --accent: #5b9cff;
      --ok: #18b26b;
      --danger: #ff6b6b;
      --ring: rgba(91, 156, 255, 0.4);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 80% -10%, #17203a 0%, #0f1115 50%, #0f1115 100%);
      color: var(--text);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header {
      position: sticky; top: 0; z-index: 5;
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; background: rgba(15,17,21,0.7);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .title {
      display: flex; align-items: baseline; gap: 10px;
      font-weight: 600; letter-spacing: 0.2px;
    }
    .subtitle { color: var(--muted); font-weight: 500; }
    .gear-btn {
      appearance: none; background: transparent; border: none; color: var(--text);
      display: inline-grid; place-items: center; width: 36px; height: 36px; border-radius: 10px; cursor: pointer;
    }
    .gear-btn:hover { background: rgba(255,255,255,0.06); }

    .container {
      display: grid; grid-template-columns: 280px 1fr; gap: 16px; padding: 16px; max-width: 1400px; margin: 0 auto;
    }

    .sidebar {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; padding: 12px;
      height: fit-content;
    }
    .sidebar h3 { margin: 4px 6px 10px; font-size: 13px; color: var(--muted); font-weight: 600; }
    .channel-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
    .channel-item {
      display: grid; grid-template-columns: 32px 1fr auto; align-items: center; gap: 10px;
      padding: 8px; border-radius: 10px; background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .force-btn {
      width: 26px; height: 26px; border-radius: 50%; display: grid; place-items: center; cursor: pointer;
      background: transparent; border: 2px solid var(--muted); color: var(--ok); font-size: 16px; line-height: 1; user-select: none;
      transition: border-color .15s ease, background .15s ease, transform .05s ease;
    }
    .force-btn:active { transform: scale(0.98); }
    .force-btn[data-color] { border-color: color-mix(in oklab, var(--muted), var(--text) 20%); }
    .force-btn.on { background: rgba(24,178,107,0.15); border-color: var(--ok); }
    .force-btn .check { opacity: 0; transition: opacity .15s ease; }
    .force-btn.on .check { opacity: 1; }

    .swatch { width: 14px; height: 14px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.3); }
    .ch-meta { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .ch-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ch-addr { color: var(--muted); font-size: 12px; }

    .chart-card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; padding: 12px; position: relative; min-height: 340px;
    }
    .chart-toolbar { display: flex; gap: 8px; align-items: center; justify-content: flex-end; margin-bottom: 8px; }
    .btn {
      appearance: none; border: 1px solid rgba(255,255,255,0.12); color: var(--text); background: rgba(255,255,255,0.04);
      border-radius: 10px; padding: 8px 10px; font-weight: 600; cursor: pointer;
    }
    .btn:hover { border-color: var(--ring); box-shadow: 0 0 0 3px var(--ring) inset; }

    canvas { width: 100% !important; height: 420px !important; }

    .footer-note { color: var(--muted); text-align: center; margin: 10px 0 24px; font-size: 12px; }

    @media (max-width: 960px) {
      .container { grid-template-columns: 1fr; }
      canvas { height: 360px !important; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div style="font-size:16px;">Температура</div>
      <div class="subtitle">8 канала · последни 24 часа</div>
    </div>
    <button class="gear-btn" id="settingsBtn" title="Настройки">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.6"/>
        <path d="M19.4 12.98c.04-.32.06-.64.06-.98s-.02-.66-.06-.98l2.02-1.58a.5.5 0 0 0 .12-.64l-1.91-3.3a.5.5 0 0 0-.6-.22l-2.38.96a7.91 7.91 0 0 0-1.7-.98l-.36-2.53A.5.5 0 0 0 14.5 1h-5a.5.5 0 0 0-.5.42l-.36 2.53c-.6.24-1.17.56-1.7.98l-2.38-.96a.5.5 0 0 0-.6.22L1.55 7.01a.5.5 0 0 0 .12.64L3.7 9.23c-.04.32-.06.64-.06.98s.02.66.06.98l-2.02 1.58a.5.5 0 0 0-.12.64l1.91 3.3c.14.24.43.34.7.22l2.38-.96c.53.42 1.1.75 1.7.98l.36 2.53c.04.25.25.42.5.42h5c.25 0 .46-.17.5-.42l.36-2.53c.6-.24 1.17-.56 1.7-.98l2.38.96c.27.12.56.02.7-.22l1.91-3.3a.5.5 0 0 0-.12-.64L19.4 12.98Z" stroke="currentColor" stroke-width="1.6"/>
      </svg>
    </button>
  </header>

  <div class="container">
    <aside class="sidebar">
      <h3>Канали</h3>
      <ul class="channel-list" id="channelList"></ul>
    </aside>

    <section class="chart-card">
      <div class="chart-toolbar">
        <button class="btn" data-range="1">1ч</button>
        <button class="btn" data-range="6">6ч</button>
        <button class="btn" data-range="12">12ч</button>
        <button class="btn" data-range="24">24ч</button>
        <button class="btn" id="resetZoomBtn">Нулирай зуум</button>
      </div>
      <canvas id="tempChart" aria-label="Графика температура"></canvas>
    </section>
  </div>

  <div class="footer-note">Скрол/пинч за зуум · влачене за панорама · щракнете кръгчето за принудителен режим ON</div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script>
    const DEFAULT_COLORS = [
      '#ff6b6b', '#5b9cff', '#ffd166', '#06d6a0',
      '#c77dff', '#4cc9f0', '#f8961e', '#2ec4b6'
    ];

    function loadConfig() {
      const stored = localStorage.getItem('thermoConfig');
      if (stored) {
        try { return JSON.parse(stored); } catch { /* ignore */ }
      }
      const channels = Array.from({ length: 8 }).map((_, i) => ({
        id: i,
        name: `Канал ${i+1}`,
        color: DEFAULT_COLORS[i % DEFAULT_COLORS.length],
        address: `28-00000${(i+1).toString().padStart(6,'0')}`,
        levelOn: 25,
        levelOff: 22
      }));
      const cfg = { channels };
      localStorage.setItem('thermoConfig', JSON.stringify(cfg));
      return cfg;
    }

    function loadForceState() {
      const raw = localStorage.getItem('thermoForceState');
      if (!raw) return {};
      try { return JSON.parse(raw) || {}; } catch { return {}; }
    }
    function saveForceState(state) {
      localStorage.setItem('thermoForceState', JSON.stringify(state));
    }

    const config = loadConfig();
    const forceState = loadForceState();

    function genDataPoints(hoursBack = 24) {
      const now = Date.now();
      const start = now - hoursBack * 60 * 60 * 1000;
      const intervalMs = 5 * 60 * 1000; // 5 минути
      const pointsCount = Math.floor((now - start) / intervalMs) + 1;
      const base = 20;
      const series = config.channels.map((ch, idx) => {
        const data = [];
        for (let i = 0; i < pointsCount; i++) {
          const t = start + i * intervalMs;
          // синусоидална промяна + шум
          const val = base + 3 * Math.sin((i / 20) + idx) + (Math.random() - 0.5) * 0.8 + idx * 0.2;
          data.push({ x: t, y: Number(val.toFixed(2)) });
        }
        return { id: ch.id, data };
      });
      return series;
    }

    const series = genDataPoints(24);

    // Създай списък канали в ляво
    const channelList = document.getElementById('channelList');
    function renderChannelList() {
      channelList.innerHTML = '';
      config.channels.forEach((ch, idx) => {
        const li = document.createElement('li');
        li.className = 'channel-item';

        const btn = document.createElement('button');
        btn.className = 'force-btn' + (forceState[ch.id] ? ' on' : '');
        btn.title = 'Принудителен режим ON/OFF';
        btn.dataset.channelId = ch.id;
        btn.style.borderColor = ch.color;
        btn.innerHTML = '<span class="check">✓</span>';
        btn.addEventListener('click', () => {
          const current = !!forceState[ch.id];
          forceState[ch.id] = !current;
          saveForceState(forceState);
          btn.classList.toggle('on', !!forceState[ch.id]);
        });

        const meta = document.createElement('div');
        meta.className = 'ch-meta';
        const sw = document.createElement('div');
        sw.className = 'swatch';
        sw.style.background = ch.color;
        const name = document.createElement('div');
        name.className = 'ch-name';
        name.textContent = ch.name;
        const addr = document.createElement('div');
        addr.className = 'ch-addr';
        addr.textContent = ch.address;
        meta.append(sw, name);

        const right = document.createElement('div');
        right.style.display = 'grid';
        right.style.justifyItems = 'end';
        right.style.gap = '2px';
        right.append(addr);

        li.append(btn, meta, right);
        channelList.append(li);
      });
    }
    renderChannelList();

    // Подготви графиката
    const ctx = document.getElementById('tempChart');
    const datasets = config.channels.map((ch, idx) => ({
      label: ch.name,
      data: series[idx].data,
      borderColor: ch.color,
      backgroundColor: ch.color + '33',
      pointRadius: 0,
      borderWidth: 2,
      tension: 0.25,
      yAxisID: 'y',
    }));

    const chart = new Chart(ctx, {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'nearest', intersect: false },
          zoom: {
            limits: { x: { minRange: 5 * 60 * 1000 } },
            pan: { enabled: true, mode: 'x', modifierKey: 'shift' },
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
          }
        },
        scales: {
          x: {
            type: 'time', time: { unit: 'hour', tooltipFormat: 'dd.MM HH:mm' },
            ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.08)' }
          },
          y: {
            title: { display: true, text: 'Температура (°C)' },
            ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.08)' }
          }
        }
      }
    });

    // Контроли за диапазон време
    function setRangeHours(hours) {
      const now = Date.now();
      const min = now - hours * 60 * 60 * 1000;
      chart.options.scales.x.min = min;
      chart.options.scales.x.max = now;
      chart.update('none');
    }

    document.querySelectorAll('.btn[data-range]').forEach(btn => {
      btn.addEventListener('click', () => setRangeHours(parseInt(btn.dataset.range, 10)));
    });
    document.getElementById('resetZoomBtn').addEventListener('click', () => {
      chart.resetZoom();
      chart.options.scales.x.min = undefined;
      chart.options.scales.x.max = undefined;
      chart.update('none');
    });

    // Настройки – парола
    document.getElementById('settingsBtn').addEventListener('click', () => {
      const pwd = localStorage.getItem('thermoSettingsPassword') || '';
      if (pwd) {
        const input = prompt('Парола за настройки:');
        if (input === null) return; // cancel
        if (input !== pwd) { alert('Грешна парола.'); return; }
        sessionStorage.setItem('thermoSettingsAuthed', '1');
      }
      window.location.href = 'settings.html';
    });
  </script>
</body>
</html>